---
import AppLayout from "@/layouts/AppLayout.astro";
import { getLangFromRequest, t } from "@/i18n";

const lang = getLangFromRequest(Astro.request);
const messages = t(lang);
const h = messages.history ?? {};
const pageTitle = h.pageTitle || "Sites history";
---

<AppLayout title={pageTitle}>
  <div class="card p-6">
    <h1 class="mb-4 text-xl font-semibold">{h.introTitle}</h1>
    <p class="mb-4 text-sm text-gray-600">
      {h.introBody}
    </p>

    <ul
      id="history"
      class="divide-y divide-gray-100"
      data-empty-label={h.empty}
      data-untitled-label={h.untitled}
      data-template-label={h.templateLabel}
      data-language-label={h.languageLabel}
      data-open-label={h.open}
      data-zip-label={h.zip}
      data-zip-error-label={h.zipError}
    ></ul>
  </div>
    <script type="module">
    import { auth } from "/src/lib/firebase.client.ts";

    async function loadHistoryForUser(user) {
      const loadingEl = document.getElementById("history-loading");
      const errorEl = document.getElementById("history-error");
      const emptyEl = document.getElementById("history-empty");
      const listEl = document.getElementById("history-list");

      if (errorEl) errorEl.classList.add("hidden");
      if (emptyEl) emptyEl.classList.add("hidden");
      if (listEl) listEl.innerHTML = "";

      let res;
      const token = await user.getIdToken(true);

      try {
        res = await fetch("/api/generator/history", {
          headers: { Authorization: `Bearer ${token}` },
        });
      } catch (e) {
        if (loadingEl) loadingEl.classList.add("hidden");
        if (errorEl) {
          errorEl.textContent =
            "Impossible de charger l'historique pour le moment.";
          errorEl.classList.remove("hidden");
        }
        return;
      }

      const text = await res.text();
      let json;
      try {
        json = JSON.parse(text);
      } catch {
        if (loadingEl) loadingEl.classList.add("hidden");
        if (errorEl) {
          errorEl.textContent = "Réponse inattendue du serveur.";
          errorEl.classList.remove("hidden");
        }
        return;
      }

      if (!res.ok || !json.ok) {
        if (loadingEl) loadingEl.classList.add("hidden");
        if (errorEl) {
          errorEl.textContent =
            json.error || "Erreur lors du chargement de l'historique.";
          errorEl.classList.remove("hidden");
        }
        return;
      }

      const items = json.items || [];

      if (loadingEl) loadingEl.classList.add("hidden");

      if (!items.length) {
        if (emptyEl) emptyEl.classList.remove("hidden");
        return;
      }

      if (listEl) {
        items.forEach((item) => {
          const li = document.createElement("li");
          li.className =
            "rounded-xl border border-slate-800/60 bg-slate-950/60 px-4 py-3";

          const date = item.createdAt
            ? new Date(item.createdAt).toLocaleString()
            : "";

          li.innerHTML = `
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="text-[10px] uppercase tracking-[0.18em] text-slate-400">
                  ${item.template || "pro"}
                </div>
                <div class="text-sm font-semibold text-slate-50">
                  ${item.elevatorPitch || "Site généré"}
                </div>
                ${
                  item.mainCTA
                    ? `<div class="mt-1 text-[11px] text-slate-400">CTA : ${
                        item.mainCTA
                      }</div>`
                    : ""
                }
              </div>
              ${
                date
                  ? `<div class="text-[11px] text-slate-500">${date}</div>`
                  : ""
              }
            </div>
          `;

          listEl.appendChild(li);
        });
      }
    }

    // ✅ On attend que Firebase nous donne l'utilisateur
    auth.onAuthStateChanged((user) => {
      const loadingEl = document.getElementById("history-loading");
      const errorEl = document.getElementById("history-error");

      if (!user) {
        if (loadingEl) loadingEl.classList.add("hidden");
        if (errorEl) {
          errorEl.textContent = "Ta session a expiré. Merci de te reconnecter.";
          errorEl.classList.remove("hidden");
        }
        window.location.href = "/auth/login";
        return;
      }

      loadHistoryForUser(user);
    });
  </script>

</AppLayout>
