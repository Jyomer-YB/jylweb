---
// src/layouts/AppLayout.astro
import "../styles/global.css";
import { getLangFromRequest, t } from "../i18n";

const lang = getLangFromRequest(Astro.request);
const i18n = t(lang);

const year = new Date().getFullYear();

const {
  title = i18n.layout.defaultTitle,
  subtitle = "",
} = Astro.props;
---

<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-50 antialiased">
    <!-- Background global avec halo bleu -->
    <div class="pointer-events-none fixed inset-0 -z-10 bg-jylweb"></div>

    <div class="relative flex min-h-screen flex-col overflow-x-hidden">
      <!-- HEADER -->
      <header
        class="sticky top-0 z-30 border-b border-slate-800/50 bg-slate-950/80 backdrop-blur-xl"
      >
        <div
          class="mx-auto flex h-16 max-w-6xl items-center justify-between px-4 sm:px-6 lg:px-8"
        >
          <!-- Logo + titre -->
          <a href="/" class="flex items-center gap-3">
            <div class="relative">
              <img
                src="/logo.png"
                alt="jyLWeb"
                class="h-8 w-auto drop-shadow-[0_0_22px_rgba(37,99,235,0.9)]"
              />
            </div>
            <div class="hidden flex-col leading-tight sm:flex">
              <span
                class="text-[11px] uppercase tracking-[0.32em] text-slate-400"
              >
                {i18n.layout.headerBadge}
              </span>
              <span class="text-sm font-medium text-slate-100">
                {i18n.layout.logoTitle}
              </span>
            </div>
          </a>

          <!-- Navigation -->
          <nav class="hidden items-center gap-7 md:flex text-xs">
            {/*
            <a href="#comment-ca-marche" class="nav-link">Comment ça marche</a>
            <a href="#pour-qui" class="nav-link">Pour qui ?</a>
            <a href="#stack" class="nav-link">Stack</a>
            */}
          </nav>

          <!-- Actions (auth-aware) -->
          <div class="flex items-center gap-3">
            <!-- Visiteur : visibles par défaut dans le HTML -->
            <a
              id="nav-login"
              href="/auth/login"
              class="text-xs font-medium text-slate-300 transition-colors hover:text-white md:inline"
            >
              {i18n.layout.login}
            </a>
            <a
              id="nav-cta"
              href="/auth/register"
              class="btn btn-brand text-[11px] px-4 py-1.5"
            >
              {i18n.layout.registerCta}
            </a>

            <!-- Utilisateur connecté : caché par défaut (classe + style) -->
            <a
              id="nav-dashboard"
              href="/app"
              class="hidden text-xs font-medium text-slate-200 transition-colors hover:text-white md:inline"
              style="display: none;"
            >
              {i18n.layout.dashboard}
            </a>
            <button
              id="nav-logout"
              type="button"
              class="hidden text-[11px] font-medium text-slate-400 transition-colors hover:text-slate-100"
              style="display: none;"
            >
              {i18n.layout.logout}
            </button>
          </div>
        </div>
      </header>

      <!-- MAIN -->
      <main
        class="mx-auto flex w-full max-w-6xl flex-1 flex-col gap-10 px-4 py-10 sm:px-6 md:py-14 lg:px-8"
      >
        {title && (
          <section class="space-y-2 md:space-y-3">
            <p
              class="text-[11px] uppercase tracking-[0.32em] text-slate-400"
            >
              {i18n.layout.mainKicker}
            </p>
            <h1
              class="text-2xl font-semibold leading-tight text-slate-50 md:text-3xl"
            >
              {title}
            </h1>
            {subtitle && (
              <p class="max-w-2xl text-sm text-slate-300 md:text-base">
                {subtitle}
              </p>
            )}
          </section>
        )}

        <section class="relative">
          <slot />
        </section>
      </main>

      <!-- FOOTER -->
      <footer class="border-t border-slate-800/60 bg-slate-950/90">
        <div
          class="mx-auto flex max-w-6xl flex-col items-center justify-between gap-3 px-4 py-6 text-[11px] text-slate-500 sm:flex-row sm:px-6 lg:px-8"
        >
          <span>
            {i18n.layout.poweredBy.replace("{year}", String(year))}
          </span>
          <span class="flex items-center gap-3">
            <span>{i18n.layout.footerRight}</span>
          </span>
        </div>
      </footer>
    </div>

    <!-- Script header: reset tout puis affiche selon la route -->
    <script type="module">
      async function handleLogout() {
        try {
          await fetch("/api/logout", { method: "POST" });
        } catch (e) {
          console.warn("[jyLWeb] Logout server error", e);
        }
        window.location.href = "/auth/login";
      }

      window.addEventListener("DOMContentLoaded", () => {
        const path = window.location.pathname;
        const isAuthedView =
          path.startsWith("/app") || path.startsWith("/generator");

        const btnLogin = document.getElementById("nav-login");
        const btnCta = document.getElementById("nav-cta");
        const btnDashboard = document.getElementById("nav-dashboard");
        const btnLogout = document.getElementById("nav-logout");

        // 1) Reset : on cache tout le monde
        [btnLogin, btnCta, btnDashboard, btnLogout].forEach((el) => {
          if (!el) return;
          el.classList.add("hidden");
          el.style.display = "none";
        });

        console.log("[jyLWeb] header path =", path, "isAuthedView =", isAuthedView);

        // 2) On affiche selon la vue
        if (isAuthedView) {
          // Vue app → Mon espace + Se déconnecter
          if (btnDashboard) {
            btnDashboard.classList.remove("hidden");
            btnDashboard.style.display = "";
          }
          if (btnLogout) {
            btnLogout.classList.remove("hidden");
            btnLogout.style.display = "";
            btnLogout.addEventListener("click", handleLogout);
          }
        } else {
          // Vue marketing/auth → Log in + CTA
          if (btnLogin) {
            btnLogin.classList.remove("hidden");
            btnLogin.style.display = "";
          }
          if (btnCta) {
            btnCta.classList.remove("hidden");
            btnCta.style.display = "";
          }
        }
      });
    </script>

    <!-- Animations scroll + parallax -->
    <script is:inline>
      (() => {
        if (typeof window === "undefined") return;

        const prefersReduced =
          window.matchMedia &&
          window.matchMedia("(prefers-reduced-motion: reduce)").matches;

        const animated = Array.from(
          document.querySelectorAll("[data-animate]")
        );

        if (!animated.length) return;

        if (prefersReduced) {
          animated.forEach((el) => el.classList.add("is-visible"));
          return;
        }

        // Fade-in on scroll
        const io = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("is-visible");
                io.unobserve(entry.target);
              }
            });
          },
          {
            threshold: 0.18,
            rootMargin: "0px 0px -10% 0px",
          }
        );

        animated.forEach((el) => io.observe(el));

        // Parallax backgrounds
        const parallaxEls = Array.from(
          document.querySelectorAll("[data-parallax]")
        );
        if (!parallaxEls.length) return;

        const handleScroll = () => {
          const y = window.scrollY || window.pageYOffset || 0;
          parallaxEls.forEach((el) => {
            const factor = parseFloat(
              el.getAttribute("data-parallax") || "0.15"
            );
            const translate = y * factor * -1;
            el.style.transform = `translate3d(0, ${translate}px, 0)`;
          });
        };

        handleScroll();
        window.addEventListener("scroll", handleScroll, { passive: true });
      })();
    </script>
  </body>
</html>
